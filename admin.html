<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Liebherr Maintenance</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
<div class="container">
<a class="navbar-brand" href="#">Liebherr Maintenance</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNav">
<ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
<li class="nav-item"><a class="nav-link" href="pending.html">Pending Work</a></li>
<li class="nav-item"><a class="nav-link" href="completed.html">Completed Work</a></li>
<li class="nav-item"><a class="nav-link" href="required.html">Required Material</a></li>
<li class="nav-item"><a class="nav-link" href="consumed.html">Consumed Material</a></li>
<li class="nav-item"><a class="nav-link" href="admin.html">Admin Panel</a></li>
<li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
</ul>
<button class="btn btn-danger" onclick="logout()">Logout</button>
</div>
</div>
</nav>

<div class="container mt-4" id="adminContent">
<h2>Admin Panel</h2>

<h3>Assign Task</h3>
<form id="assignTaskForm">
<div class="row">
<div class="col-md-6 mb-3">
<input type="text" class="form-control" placeholder="Machine/Area Name" id="machineName" required>
</div>

<div class="col-md-6 mb-3">
<input type="text" class="form-control" placeholder="Issue" id="issue" required>
</div>

<div class="col-md-6 mb-3">
<select class="form-control" id="priority" required>
<option>High</option>
<option>Medium</option>
<option>Low</option>
</select>
</div>

<div class="col-md-6 mb-3">
<input type="date" class="form-control" id="taskDate" required>
</div>

<!-- USER DROPDOWN INSTEAD OF MANUAL INPUT -->
<div class="col-md-6 mb-3">
<select class="form-control" id="assignUsername" required>
<option value="">Select User</option>
</select>
</div>
</div>

<button type="submit" class="btn btn-primary btn-sm">Assign Task</button>
</form>

<h3 class="mt-4">Password Reset Requests</h3>
<ul id="resetRequests"></ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Ensure storage exists
if (!localStorage.getItem('pendingTasks')) {
localStorage.setItem('pendingTasks', JSON.stringify([]));
}
if (!localStorage.getItem('passwordResetRequests')) {
localStorage.setItem('passwordResetRequests', JSON.stringify([]));
}

function getCurrentUser() {
return sessionStorage.getItem('currentUser')
? JSON.parse(sessionStorage.getItem('currentUser'))
: null;
}

function isAdmin() {
const user = getCurrentUser();
return user && user.isAdmin;
}

function logout() {
sessionStorage.removeItem('currentUser');
window.location.href = 'login.html';
}

function checkLogin() {
if (!getCurrentUser()) {
window.location.href = 'login.html';
}
}

// Auto-set today's date
function setTodayDateForAdmin() {
const today = new Date().toISOString().split('T')[0];
document.getElementById('taskDate').value = today;
}

// Load users from login.js storage into dropdown
function loadUsersIntoDropdown() {
const users = JSON.parse(localStorage.getItem('users')) || [];
const dropdown = document.getElementById('assignUsername');
dropdown.innerHTML = '<option value="">Select User</option>';

users.forEach(user => {
const option = document.createElement('option');
option.value = user.username;
option.textContent = user.username;
dropdown.appendChild(option);
});
}

// BLOCK NON-ADMINS
if (!isAdmin()) {
document.getElementById('adminContent').innerHTML =
'<p class="text-danger fw-bold">Access Denied! Only Admin can view this page.</p>';
} else {

// Load password reset requests
const requests = JSON.parse(localStorage.getItem('passwordResetRequests'));
const ul = document.getElementById('resetRequests');
ul.innerHTML = '';

requests.forEach((req, index) => {
ul.innerHTML += `
<li>${req.username}
<button class="btn btn-warning btn-sm ms-2" onclick="resetPassword(${index})">
Reset Password
</button>
</li>`;
});

// Assign Task handler
document.getElementById('assignTaskForm').addEventListener('submit', function(e) {
e.preventDefault();

const adminUser = getCurrentUser(); // WHO ASSIGNED THE TASK

const task = {
machineName: document.getElementById('machineName').value,
issue: document.getElementById('issue').value,
priority: document.getElementById('priority').value,
date: document.getElementById('taskDate').value,
assignedTo: document.getElementById('assignUsername').value,
assignedBy: adminUser.username   // NEW FIELD ✅
};

const tasks = JSON.parse(localStorage.getItem('pendingTasks')) || [];
tasks.push(task);
localStorage.setItem('pendingTasks', JSON.stringify(tasks));

alert('Task assigned successfully.');
this.reset();
setTodayDateForAdmin();
});
}

function resetPassword(index) {
    let requests = JSON.parse(localStorage.getItem('passwordResetRequests')) || [];
    const username = requests[index].username;

    const newPassword = prompt('Enter new password for ' + username);

    if (!newPassword) {
        alert("Password not changed.");
        return;
    }

    let users = JSON.parse(localStorage.getItem('users')) || [];

    const userIndex = users.findIndex(u => u.username === username);

    if (userIndex === -1) {
        alert("User not found!");
        return;
    }

    // ✅ ACTUALLY UPDATE PASSWORD
    users[userIndex].password = newPassword;
    localStorage.setItem('users', JSON.stringify(users));

    // ✅ REMOVE RESET REQUEST AFTER SUCCESS
    requests.splice(index, 1);
    localStorage.setItem('passwordResetRequests', JSON.stringify(requests));

    alert(`Password updated for ${username}`);

    // Refresh admin panel list
    location.reload();
}


document.addEventListener('DOMContentLoaded', function() {
checkLogin();
setTodayDateForAdmin();
loadUsersIntoDropdown();
});
</script>
</body>
</html>


